
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Natsch PoD Calculator — Marvelous Maura Model (v6.1)</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#0f172a;--muted:#5b6475;--accent:#0ea5e9;--line:#e5e7eb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:26px;margin:0 0 6px}
  .muted{color:var(--muted)} .small{font-size:12px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  .card .bd{padding:14px}
  .grid{display:grid;gap:12px}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:1000px){.cols-3,.cols-2{grid-template-columns:1fr}}
  label{font-size:12px;font-weight:600;display:block}
  input,select,button,textarea{font:inherit}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  input[readonly]{background:#f8fafc}
  .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:white;padding:9px 12px;border-radius:12px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#e8f5ff;font-size:12px;color:#0369a1}
  table{width:100%;border-collapse:collapse;font-size:14px} th,td{border-bottom:1px solid var(--line);padding:6px 8px;text-align:left}
  .hr{height:1px;background:var(--line);margin:12px 0}
  pre.sig{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px;display:inline-block;text-align:left}
  .badge{font-size:11px;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#0b5fb0;border:1px solid #b6dbff}
  .note{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:8px;border-radius:10px;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <h1>Natsch PoD Calculator — <em>Marvelous Maura Model</em> (v6.1)</h1>
  <div class="muted">Implements equations EQ1, EQ4, EQ5, EQ6, EQ7 exactly as in the Natsch calculator templates. Defaults and normalizations match the papers.</div>

  <div style="margin:8px 0 16px; display:flex; gap:8px; align-items:center">
    <button type="button" id="openSettings" class="btn pill">Settings</button>
    <span class="small muted">Set an EPA CompTox API key for auto‑filling vapor pressure (optional).</span>
  </div>

  <!-- CHEMICAL + VP -->
  <div class="card">
    <div class="hd"><h2 style="margin:0;font-size:16px">1) Chemical identification</h2></div>
    <div class="bd">
      <div class="grid cols-3">
        <div>
          <label>CAS number</label>
          <div class="row" style="grid-template-columns:1fr auto">
            <input id="cas" placeholder="e.g., 104-55-2">
            <button type="button" class="btn" id="btnLookup">Lookup (PubChem)</button>
          </div>
          <div id="pubchemNote" class="note" style="display:none; margin-top:6px"></div>
        </div>
        <div>
          <label>Chemical name</label>
          <input id="name" placeholder="auto-filled or type…">
        </div>
        <div>
          <label>Molecular weight (g/mol)</label>
          <input id="mw" type="number" step="0.01" placeholder="e.g., 132.16">
        </div>
      </div>

      <div class="small" style="margin-top:8px">
        <span class="badge">Optional</span> Load a local CAS→Name/MW/VP catalog (CSV/JSON; headers: <code>CAS,Name,MW,VP_Pa,VP_mmHg</code>).
        <input type="file" id="catFile" accept=".csv,.json" style="margin-left:8px">
        <span id="catStatus" class="small"></span>
      </div>

      <div class="hr"></div>
      <div class="grid cols-3">
        <div>
          <label>Vapor pressure (Pa)</label>
          <input id="vp_pa" type="number" step="0.0001" placeholder="TIMES‑SS (Pa) or converted">
        </div>
        <div>
          <label>Vapor pressure (mmHg)</label>
          <div class="row" style="grid-template-columns:1fr auto">
            <input id="vp_mmhg" type="number" step="0.000001" placeholder="EPA Dashboard value">
            <button type="button" class="btn" id="fetchVpEPA" title="Auto-fill from EPA CompTox">Auto‑fill from EPA</button>
          </div>
        </div>
        <div>
          <label>LogVP<sub>norm</sub> (auto)</label>
          <input id="vp_norm" readonly>
          <div class="small">= log10(Pa) − 1; negatives → 0. (Pa is authoritative)</div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <button type="button" class="btn" id="btnOpenEPA">Open EPA Dashboard for this CAS</button>
          <div class="small">Grab VP in mmHg; the app converts to Pa with 1 mmHg = 133.322 Pa.</div>
          <div id="epaNote" class="note" style="display:none; margin-top:6px"></div>
        </div>
        <div>
          <label class="small"><input type="checkbox" id="vp_override"> Stop auto-sync Pa↔mmHg</label>
        </div>
      </div>
    </div>
  </div>

  <!-- ASSAYS -->
  <div class="grid cols-3" style="margin-top:16px">
    <div class="card">
      <div class="hd"><h2 style="margin:0;font-size:16px">2) kDPRA (KE1)</h2></div>
      <div class="bd">
        <div class="row">
          <div>
            <label>log k<sub>max</sub> (s⁻¹·M⁻¹)</label>
            <input id="logk" type="number" step="0.01" placeholder="-3.5 to 0+">
          </div>
          <div>
            <label>log k<sub>max</sub><sub>norm</sub> (auto)</label>
            <input id="logk_norm" readonly>
            <div class="small">= log kmax + 3.5; clamp below 0 → 0.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2 style="margin:0;font-size:16px">3) KeratinoSens™ (KE2)</h2></div>
      <div class="bd">
        <div class="row">
          <label>KS units</label>
          <select id="ks_units"><option value="uM">µM (default)</option><option value="ugml">µg/mL (convert)</option></select>
        </div>
        <div class="row"><div><label>EC1.5</label><input id="ks_ec15" type="number" step="0.01"></div><div><label>EC1.5 (µM, auto)</label><input id="ks_ec15_uM" readonly></div></div>
        <div class="row"><div><label>EC3 (optional)</label><input id="ks_ec3" type="number" step="0.01"></div><div><label>EC3 (µM, auto)</label><input id="ks_ec3_uM" readonly></div></div>
        <div class="row"><div><label>IC50</label><input id="ks_ic50" type="number" step="0.01"></div><div><label>IC50 (µM, auto)</label><input id="ks_ic50_uM" readonly></div></div>
        <div class="row"><div><label>EC1.5_norm</label><input id="ks_ec15_norm" readonly></div><div><label>EC3_norm</label><input id="ks_ec3_norm" readonly></div></div>
        <div class="row"><div><label>IC50_norm</label><input id="ks_ic50_norm" readonly></div></div>
        <div class="small">If blank (no effect at max), defaults to 4000 µM prior to normalization.</div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2 style="margin:0;font-size:16px">4) h‑CLAT (KE3)</h2></div>
      <div class="bd">
        <div class="row">
          <label>h‑CLAT units</label>
          <select id="hclat_units"><option value="uM">µM (preferred)</option><option value="ugml">µg/mL (convert)</option></select>
        </div>
        <div class="row"><div><label>EC150 (CD86)</label><input id="h_ec150" type="number" step="0.01"></div><div><label>EC200 (CD54)</label><input id="h_ec200" type="number" step="0.01"></div></div>
        <div class="row"><div><label>MIT (µM, auto = min(EC150, EC200))</label><input id="h_mit_uM" readonly></div><div><label>CV75</label><input id="h_cv75" type="number" step="0.01"></div></div>
        <div class="row"><div><label>CV75 (µM, auto)</label><input id="h_cv75_uM" readonly></div><div><label>MIT_norm</label><input id="h_mit_norm" readonly></div></div>
        <div class="row"><div><label>CV75_norm</label><input id="h_cv75_norm" readonly></div></div>
        <div class="small">If blank (no effect at max), use MIT=25,000 µM and CV75=5,000 µg/mL (converted) before normalization.</div>
      </div>
    </div>
  </div>

  <!-- PDF EXTRACTOR -->
  <div class="card" style="margin-top:16px">
    <div class="hd"><h2 style="margin:0;font-size:16px">5) Optional: extract from a report (TIMES‑SS / study PDF)</h2><span class="pill">Parsing runs locally; files are not uploaded or saved.</span></div>
    <div class="bd">
      <div class="row" style="grid-template-columns:1fr auto">
        <input type="file" id="pdfInput" accept="application/pdf">
        <button type="button" class="btn" id="btnParsePDF">Extract from PDF</button>
      </div>
      <div class="small" style="margin-top:6px">If your network blocks the PDF engine, paste report text below and click “Parse text.”</div>
      <textarea id="pdfText" rows="6" placeholder="…or paste text from the report here"></textarea>
      <div class="row" style="grid-template-columns:auto auto auto 1fr;margin-top:8px">
        <button type="button" class="btn" id="btnParseText">Parse text</button>
        <button type="button" class="btn" id="btnFillFound">Apply found values</button>
        <div class="small" id="parseStatus"></div>
      </div>
      <div id="found" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- CALC -->
  <div class="card" style="margin-top:16px">
    <div class="hd"><h2 style="margin:0;font-size:16px">6) Calculate PoD</h2><span class="pill">pEC3 and EC3 (% w/w) via EQ1, EQ4, EQ5, EQ6, EQ7.</span></div>
    <div class="bd">
      <div class="row" style="grid-template-columns:auto auto 1fr">
        <button type="button" class="btn primary" id="btnCalc">Calculate</button>
        <button type="button" class="btn" id="btnClear">Clear</button>
      </div>
      <div id="results" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- SOURCE FINDER -->
  <div class="card" style="margin-top:16px">
    <div class="hd"><h2 style="margin:0;font-size:16px">7) Data source finder</h2></div>
    <div class="bd">
      <div class="row" style="grid-template-columns:1fr auto auto">
        <input id="srcCas" placeholder="CAS for search links (defaults to the top CAS field)">
        <button type="button" class="btn" id="btnMakeLinks">Make links</button>
        <button type="button" class="btn" id="btnOpenAll">Open all</button>
      </div>
      <div id="links" class="small" style="margin-top:8px"></div>
      <div class="small" style="margin-top:8px">Opens official portals with your CAS prefilled: EPA CompTox, PubChem, OECD eChemPortal, ECHA, Google Scholar, PubMed.</div>
    </div>
  </div>

  <footer style="margin:22px 0;text-align:center">
    <pre class="sig">  (\_/)   (\_/)   (\_/)   (\_/)
  ('.'.)  ('.'.)  ('.'.)  ('.'.)
  (")(")  (")(")  (")(")  (")(") 
This has been a (>-.-)> Maura Lavelle <(-.-)> Production!!</pre>
  </footer>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h3 style="margin:0 0 8px">Settings</h3>
    <label>EPA CompTox API key
      <input id="ctxKey" type="password" placeholder="paste your key here"/>
    </label>
    <div class="row" style="margin-top:10px">
      <button type="button" id="saveCtxKey" class="btn">Save</button>
      <button type="button" id="closeSettings" class="btn">Close</button>
    </div>
    <p class="small muted" style="margin-top:6px">
      Stored locally in your browser (localStorage). Not uploaded anywhere.
    </p>
  </div>
</div>

<script type="module">
const Q = s => document.querySelector(s);
const log10 = x => Math.log10(x);
const clamp0 = x => Math.max(0, x);

// Helpers
function setNote(id, html){ const el = Q('#'+id); if(!el) return; el.innerHTML = html; el.style.display = 'block'; }
function clearNote(id){ const el = Q('#'+id); if(!el) return; el.innerHTML = ''; el.style.display = 'none'; }

// Modal wiring
const settingsModal = document.getElementById("settingsModal");
document.getElementById("openSettings").onclick = () => {
  const key = localStorage.getItem("ctxApiKey") || "";
  document.getElementById("ctxKey").value = key;
  settingsModal.classList.remove("hidden");
};
document.getElementById("closeSettings").onclick = () => settingsModal.classList.add("hidden");
document.getElementById("saveCtxKey").onclick = () => {
  localStorage.setItem("ctxApiKey", document.getElementById("ctxKey").value.trim());
  settingsModal.classList.add("hidden");
};

// Catalog loader
let CATALOG = null;
Q('#catFile').addEventListener('change', async e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  let obj = null, rows = 0;
  try{
    if(f.name.toLowerCase().ends_with('.json')){
      obj = JSON.parse(txt);
      rows = Array.isArray(obj) ? obj.length : Object.keys(obj||{}).length;
    }else{
      const lines = txt.trim().split(/\r?\n/);
      const head = lines.shift().split(',').map(s=>s.trim().toLowerCase());
      const idx = (k)=>head.indexOf(k);
      const iCAS=idx('cas'), iName=idx('name'), iMW=idx('mw'), iPa=idx('vp_pa'), iHg=idx('vp_mmhg');
      obj = {};
      for(const ln of lines){
        const cells = ln.split(',').map(s=>s.trim());
        const cas = cells[iCAS];
        if(!cas) continue;
        obj[cas] = {name: cells[iName]||'', mw: parseFloat(cells[iMW]), pa: parseFloat(cells[iPa]), mmhg: parseFloat(cells[iHg])};
        rows++;
      }
    }
    CATALOG = obj;
    Q('#catStatus').textContent = `Loaded ${rows} entries.`;
    tryCatalogFill();
  }catch(err){
    Q('#catStatus').textContent = 'Could not read file.';
  }
});

function tryCatalogFill(){
  if(!CATALOG) return;
  const cas = (Q('#cas').value||'').trim();
  if(!cas) return;
  const rec = Array.isArray(CATALOG) ? CATALOG.find(r=>r.CAS===cas || r.cas===cas) : CATALOG[cas];
  if(!rec) return;
  if(rec.name && !Q('#name').value) Q('#name').value = rec.name;
  if(rec.mw && !Q('#mw').value) Q('#mw').value = rec.mw;
  if(rec.pa){ Q('#vp_pa').value = rec.pa; syncVP('pa'); }
  else if(rec.mmhg){ Q('#vp_mmhg').value = rec.mmhg; syncVP('mm'); }
}

// VP sync
function syncVP(from){
  const paEl = Q('#vp_pa'), mmEl = Q('#vp_mmhg'), normEl = Q('#vp_norm');
  if(Q('#vp_override').checked){
    const pa = parseFloat(paEl.value);
    normEl.value = isFinite(pa) && pa>0 ? (clamp0(log10(pa)-1)).toFixed(4) : '0.0000';
    return;
  }
  const mm2pa = 133.322;
  if(from==='pa'){ const pa = parseFloat(paEl.value); if(isFinite(pa)) mmEl.value = (pa/mm2pa).toFixed(6); }
  if(from==='mm'){ const mm = parseFloat(mmEl.value); if(isFinite(mm)) paEl.value = (mm*mm2pa).toFixed(4); }
  const pa = parseFloat(paEl.value);
  normEl.value = isFinite(pa) && pa>0 ? (clamp0(log10(pa)-1)).toFixed(4) : '0.0000';
}

// KS conversion & norms
function unitConvertKS(){
  const units = Q('#ks_units').value;
  const mw = parseFloat(Q('#mw').value);
  const toUM = v => {
    const x = parseFloat(v);
    if(!isFinite(x)) return null;
    if(units==='uM') return x;
    if(units==='ugml' && isFinite(mw) && mw>0) return x*1000/mw;
    return null;
  };
  const ec15 = toUM(Q('#ks_ec15').value) ?? 4000;
  const ec3  = toUM(Q('#ks_ec3').value)  ?? 4000;
  const ic50 = toUM(Q('#ks_ic50').value) ?? 4000;
  Q('#ks_ec15_uM').value = isFinite(ec15)? ec15.toFixed(2):'';
  Q('#ks_ec3_uM').value  = isFinite(ec3)?  ec3.toFixed(2):'';
  Q('#ks_ic50_uM').value = isFinite(ic50)? ic50.toFixed(2):'';
  let e15n = clamp0(-log10(ec15) + log10(4000));
  let e3n  = clamp0(-log10(ec3)  + log10(4000));
  let icn  = clamp0(-log10(ic50) + log10(4000));
  Q('#ks_ec15_norm').value = e15n.toFixed(4);
  Q('#ks_ec3_norm').value  = e3n.toFixed(4);
  Q('#ks_ic50_norm').value = icn.toFixed(4);
}

// h-CLAT conversion & norms
function unitConvertH(){
  const units = Q('#hclat_units').value;
  const mw = parseFloat(Q('#mw').value);
  const toUM = v => {
    const x = parseFloat(v);
    if(!isFinite(x)) return null;
    if(units==='uM') return x;
    if(units==='ugml'){ if(!isFinite(mw)||mw<=0) return null; return x*1000/mw; }
    return null;
  };
  const e150 = toUM(Q('#h_ec150').value) ?? 25000;
  const e200 = toUM(Q('#h_ec200').value) ?? 25000;
  const mit  = Math.min(e150, e200);
  Q('#h_mit_uM').value = isFinite(mit)? mit.toFixed(2):'';

  let cv75uM = toUM(Q('#h_cv75').value);
  if(cv75uM==null){
    if(units==='ugml' && isFinite(mw) && mw>0) cv75uM = (5000*1000)/mw; else cv75uM = 25000;
  }
  Q('#h_cv75_uM').value = isFinite(cv75uM)? cv75uM.toFixed(2):'';

  let mitn = clamp0(-log10(mit) + log10(25000));
  let cvn  = clamp0(-log10(cv75uM) + log10(25000));
  Q('#h_mit_norm').value = mitn.toFixed(4);
  Q('#h_cv75_norm').value = cvn.toFixed(4);
}

// kDPRA norm
function computeKnorm(){
  let lk = parseFloat(Q('#logk').value);
  let kn = (isFinite(lk) ? (lk + 3.5) : 0);
  if(!isFinite(kn) || kn<0) kn = 0;
  Q('#logk_norm').value = kn.toFixed(4);
}

function recalcAll(){ syncVP('pa'); computeKnorm(); unitConvertKS(); unitConvertH(); }
function usable(x){ return isFinite(x) && x>0; }

function calc(){
  recalcAll();
  const mw  = parseFloat(Q('#mw').value);
  const vpN = parseFloat(Q('#vp_norm').value) || 0;
  const kN  = parseFloat(Q('#logk_norm').value) || 0;
  const e15 = parseFloat(Q('#ks_ec15_norm').value) || 0;
  const e3  = parseFloat(Q('#ks_ec3_norm').value) || 0;
  const ic  = parseFloat(Q('#ks_ic50_norm').value) || 0;
  const mit = parseFloat(Q('#h_mit_norm').value) || 0;
  const cv  = parseFloat(Q('#h_cv75_norm').value) || 0;

  const rows = [];
  const add = (label, p) => rows.push({label, p, EC3: (isFinite(mw)&&isFinite(p))? (mw/Math.pow(10,p)) : NaN});

  if(usable(kN) && (usable(e15)||usable(ic))) add('EQ1 (kDPRA + KS + VP)', 0.42 + 0.40*kN + 0.15*e15 + 0.36*ic - 0.21*vpN);
  if(usable(kN) && (usable(mit)||usable(cv))) add('EQ4 (kDPRA + h-CLAT + VP)', 0.18 + 0.36*kN + 0.21*mit + 0.35*cv - 0.19*vpN);
  if(usable(kN) && (usable(e15)||usable(ic)) && (usable(mit)||usable(cv))) add('EQ5 (kDPRA + KS + h-CLAT + VP)', 0.20 + 0.34*kN + 0.20*mit + 0.09*e15 + 0.21*cv + 0.11*ic - 0.19*vpN);
  if(!usable(kN) && (usable(e15)||usable(ic)) && (usable(mit)||usable(cv))) add('EQ6 (KS + h-CLAT + VP)', 0.09 + 0.276*mit + 0.22*e15 + 0.34*cv + 0.06*ic - 0.12*vpN);
  if(!usable(kN) && usable(e3) && (usable(mit)||usable(cv))) add('EQ7 (KS EC3 + h-CLAT + VP)', 0.202 + 0.222*mit + 0.40*e3 + 0.313*cv + 0.023*ic - 0.151*vpN);

  const t = Q('#results');
  if(rows.length===0){ t.innerHTML = '<div class="muted">Not enough inputs to compute.</div>'; return; }

  let rec = null; for(const tag of ['EQ5','EQ1','EQ4','EQ7','EQ6']){ const r = rows.find(x=>x.label.startsWith(tag)); if(r){rec=r; break;} }
  let html = '';
  if(rec){
    html += `<div class="card" style="border:1px dashed var(--accent);padding:12px;border-radius:12px;margin-bottom:12px;background:#f0f9ff">
      <div class="grid cols-3">
        <div><div class="muted">Recommended (per data availability)</div><div style="font-size:18px"><b>${rec.label}</b></div></div>
        <div><div class="muted">pEC3</div><div style="font-size:20px">${rec.p.toFixed(3)}</div></div>
        <div><div class="muted">EC3 (% w/w)</div><div style="font-size:20px">${isFinite(rec.EC3)? rec.EC3.toFixed(2): '—'}</div></div>
      </div>
    </div>`;
  }
  html += '<table><thead><tr><th>Equation</th><th>pEC3</th><th>EC3 (% w/w)</th></tr></thead><tbody>';
  html += rows.map(r=>`<tr><td>${r.label}</td><td>${r.p.toFixed(3)}</td><td>${isFinite(r.EC3)? r.EC3.toFixed(2): '—'}</td></tr>`).join('');
  html += '</tbody></table>';
  t.innerHTML = html;
}

// Source finder
function makeLinks(){
  const cas = (Q('#srcCas').value || Q('#cas').value || '').trim();
  if(!cas){ alert('Enter a CAS first.'); return; }
  const links = [
    ['EPA CompTox Dashboard', `https://comptox.epa.gov/dashboard/dsstoxdb/results?search=${encodeURIComponent(cas)}`],
    ['PubChem', `https://pubchem.ncbi.nlm.nih.gov/#query=${encodeURIComponent(cas)}`],
    ['OECD eChemPortal', `https://www.echemportal.org/echemportal/substancesearch/substancesearch.do?searchTerm=${encodeURIComponent(cas)}`],
    ['ECHA (site search)', `https://www.google.com/search?q=site:echa.europa.eu+${encodeURIComponent(cas)}+skin+sensitization`],
    ['Google Scholar', `https://scholar.google.com/scholar?q=${encodeURIComponent(cas)}+KeratinoSens+OR+%22h-CLAT%22+OR+DPRA+OR+kDPRA`],
    ['PubMed', `https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(cas)}+skin+sensitization+OR+KeratinoSens+OR+h-CLAT+OR+DPRA+OR+kDPRA`]
  ];
  Q('#links').innerHTML = links.map(([n,u])=>`<a href="${u}" target="_blank" rel="noreferrer noopener">${n}</a>`).join(' &nbsp;|&nbsp; ');
  Q('#links')._urls = links.map(x=>x[1]);
}
function openAll(){ (Q('#links')._urls||[]).forEach(u=>window.open(u,'_blank')); }
document.getElementById('btnMakeLinks').addEventListener('click', makeLinks);
document.getElementById('btnOpenAll').addEventListener('click', openAll);

// PubChem lookup with robust fallback
document.getElementById('btnLookup').addEventListener('click', ()=>{
  clearNote('pubchemNote');
  const cas = (Q('#cas').value||'').trim();
  if(!cas){ alert('Enter a CAS first.'); return; }
  fetch(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(cas)}/property/IUPACName,MolecularWeight/JSON`)
    .then(r=>r.ok?r.json():Promise.reject(r))
    .then(d=>{
      const p=d?.PropertyTable?.Properties?.[0];
      if(p?.IUPACName&&!Q('#name').value) Q('#name').value=p.IUPACName;
      if(p?.MolecularWeight&&!Q('#mw').value) Q('#mw').value=(+p.MolecularWeight).toFixed(2);
      if(!p) throw new Error('No PubChem record returned');
    })
    .catch(()=>{
      const u = `https://pubchem.ncbi.nlm.nih.gov/#query=${encodeURIComponent(cas)}`;
      setNote('pubchemNote', `Couldn’t fetch via API (network policy or CORS). <a href="${u}" target="_blank" rel="noreferrer noopener">Open PubChem search</a>.`);
    });
});

// EPA Dashboard button with popup‑blocker fallback
document.getElementById('btnOpenEPA').addEventListener('click', ()=>{
  clearNote('epaNote');
  const cas = (Q('#cas').value||'').trim();
  const url = cas ? `https://comptox.epa.gov/dashboard/dsstoxdb/results?search=${encodeURIComponent(cas)}` : 'https://comptox.epa.gov/dashboard/';
  const w = window.open(url, '_blank');
  if(!w){ // blocked
    setNote('epaNote', `Your browser blocked the new tab. <a href="${url}">Open EPA CompTox in this tab</a>.`);
    // navigate as a final fallback:
    // location.href = url; // uncomment if you always prefer same‑tab navigation
  }
});

// EPA API auto‑fill (requires key). Graceful fallback: open CCD if no key.
const CTX_ROOT = "https://api-ccte.epa.gov";
document.getElementById('fetchVpEPA').addEventListener('click', async ()=>{
  const cas = (Q('#cas').value||'').trim();
  if(!cas){ alert('Enter a CAS first.'); return; }
  const key = localStorage.getItem("ctxApiKey");
  if(!key){ // no key? open dashboard as convenience
    const url = `https://comptox.epa.gov/dashboard/dsstoxdb/results?search=${encodeURIComponent(cas)}`;
    const w = window.open(url, "_blank");
    if(!w){ setNote('epaNote', `No API key set. <a href="${url}">Open EPA CompTox search</a>.`); }
    return;
  }
  try{
    // 1) CAS -> DTXSID
    const res1 = await fetch(`${CTX_ROOT}/chemical/v1/chemicals?search=${encodeURIComponent(cas)}&searchParameter=casrn`, { headers: { "x-api-key": key }});
    if(!res1.ok) throw new Error("DTXSID search failed");
    const js1 = await res1.json();
    const dtxsid = js1?.data?.[0]?.dtxsid || js1?.[0]?.dtxsid;
    if(!dtxsid) throw new Error("No DTXSID found for that CAS.");

    // 2) DTXSID -> physchem rows
    const res2 = await fetch(`${CTX_ROOT}/chemical/v1/physchem?dtxsid=${encodeURIComponent(dtxsid)}`, { headers: { "x-api-key": key }});
    if(!res2.ok) throw new Error("Phys-chem lookup failed");
    const js2 = await res2.json();
    const rows = js2?.data || js2 || [];
    const onlyVP = rows.filter(r => (r.propertyId || r.propertyID) === "vapor-pressure");
    // prefer experimental mmHg, else predicted mmHg, else first numeric
    let hit = onlyVP.find(r => (r.propType||'').toLowerCase()==='experimental' && (r.unit||'').toLowerCase()==='mmhg');
    if(!hit) hit = onlyVP.find(r => (r.propType||'').toLowerCase()==='predicted' && (r.unit||'').toLowerCase()==='mmhg');
    if(!hit) hit = onlyVP[0];
    const mmHg = (hit && (typeof hit.value==='number' ? hit.value : Number(hit.value))) || null;
    if(!mmHg) throw new Error("No vapor-pressure value found.");
    Q('#vp_mmhg').value = mmHg;
    Q('#vp_pa').value = (mmHg * 133.322).toFixed(4);
    syncVP('mm');
  }catch(err){
    const url = `https://comptox.epa.gov/dashboard/dsstoxdb/results?search=${encodeURIComponent(cas)}`;
    setNote('epaNote', `EPA API call failed (check API key / network). <a href="${url}" target="_blank" rel="noreferrer noopener">Open CompTox search</a>.`);
  }
});

// Input listeners
document.addEventListener('input', (e)=>{
  if(e.target.id==='vp_pa') syncVP('pa');
  if(e.target.id==='vp_mmhg') syncVP('mm');
  if(['ks_units','ks_ec15','ks_ec3','ks_ic50','mw'].includes(e.target.id)) unitConvertKS();
  if(['hclat_units','h_ec150','h_ec200','h_cv75','mw'].includes(e.target.id)) unitConvertH();
  if(['logk'].includes(e.target.id)) computeKnorm();
  if(e.target.id==='cas') tryCatalogFill();
});

document.getElementById('btnCalc').addEventListener('click', calc);
document.getElementById('btnClear').addEventListener('click', ()=>location.reload());

// initial
syncVP('pa'); unitConvertKS(); unitConvertH(); computeKnorm(); makeLinks();
</script>
</body>
</html>
